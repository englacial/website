<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>ISMIP6 Model Viewer –  englacial</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./images/logo_snowflake.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-960d9d362f81d399278ec3e29b622b37.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/quarto-contrib/fontawesome6-6.7.2/all.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/fontawesome6-6.7.2/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- Privacy-friendly analytics by Plausible -->
<script async="" src="https://plausible.io/js/pa-AegmHWgLHcdedZvtA_uM7.js"></script>
<script>
  window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
  plausible.init()
</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title"><img src="./images/logo_snowflake.png" style="max-height: 1.5em;"> englacial</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">about</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-models" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">models</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-models">    
        <li>
    <a class="dropdown-item" href="./static/models/">
 <span class="dropdown-text">Viewer</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./models.html">
 <span class="dropdown-text">Examples</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-projects" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">projects</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-projects">    
        <li>
    <a class="dropdown-item" href="https://github.com/englacial/xopr" target="_blank">
 <span class="dropdown-text">xOPR&nbsp;&nbsp;<i class="fa-solid fa-arrow-up-right-from-square" aria-label="arrow-up-right-from-square"></i></span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./pages/2025-living-data-products.html">
 <span class="dropdown-text">Living Data Products</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./pages/2026-hackdays.html">
 <span class="dropdown-text">Connected Data Products Hackdays</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="./updates.html"> 
<span class="menu-text">updates</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/englacial"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-this" id="toc-what-is-this" class="nav-link active" data-scroll-target="#what-is-this">What is this?</a>
  <ul class="collapse">
  <li><a href="#more-about-ismip6-and-the-context-behind-these-models" id="toc-more-about-ismip6-and-the-context-behind-these-models" class="nav-link" data-scroll-target="#more-about-ismip6-and-the-context-behind-these-models">More about ISMIP6 and the context behind these models</a></li>
  <li><a href="#open-source" id="toc-open-source" class="nav-link" data-scroll-target="#open-source">Open Source</a></li>
  </ul></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting started</a>
  <ul class="collapse">
  <li><a href="#subglacial-temperature" id="toc-subglacial-temperature" class="nav-link" data-scroll-target="#subglacial-temperature">Subglacial temperature</a></li>
  <li><a href="#grounding-line-retreat-and-sub-ice-shelf-melt" id="toc-grounding-line-retreat-and-sub-ice-shelf-melt" class="nav-link" data-scroll-target="#grounding-line-retreat-and-sub-ice-shelf-melt">Grounding line retreat and sub-ice shelf melt</a></li>
  <li><a href="#surface-mass-balance" id="toc-surface-mass-balance" class="nav-link" data-scroll-target="#surface-mass-balance">Surface mass balance</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">ISMIP6 Model Viewer</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="what-is-this" class="level1">
<h1>What is this?</h1>
<p>This is a visualization tool for exploring and comparing model outputs from the Ice Sheet Model Inter-comparison Project for CMIP6 (ISMIP6). <a href="https://www.ismip.org/">ISMIP</a> is an international collaborative effort to compare the behavior of ice sheet models under a standardized set of experiments. This tool is not affiliated with ISMIP – it’s just a visualizer of publicly-available ISMIP6 outputs, which are <a href="https://source.coop/englacial/ismip6">hosted here on source.coop</a>.</p>
<p>The tool is a prototype article for a larger push we’re working on to build backend infrastructure for model-data comparisons. If you’re interested in that, feel free to check back here as we add more information or reach out to either shane.grigsby@astera.org or thomas.teisberg@astera.org.</p>
<p>We hope this tool is useful and interesting to the scientific community. If you find it useful or you find issues, we encourage you to email us or <a href="https://github.com/englacial/ismip-indexing/issues/new">open an issue</a>.</p>
<section id="more-about-ismip6-and-the-context-behind-these-models" class="level2">
<h2 class="anchored" data-anchor-id="more-about-ismip6-and-the-context-behind-these-models">More about ISMIP6 and the context behind these models</h2>
<p>This tool visualizes only model outputs from the ISMIP6 Antarctica ensemble for now. The general structure of those experiments is described <a href="https://theghub.org/groups/ismip6/wiki/MainPage/ISMIP6ProjectionsAntarctica">on the ISMIP6 wiki</a>. For details, please read the <a href="https://tc.copernicus.org/articles/14/3033/2020/">ISMIP6 Antarctica results paper</a> in <em>The Cryosphere</em>.</p>
</section>
<section id="open-source" class="level2">
<h2 class="anchored" data-anchor-id="open-source">Open Source</h2>
<p>This tool is open source, and consists of two components: a front end viewer, and a back-end connection to the virtualized dataset. Both of these components are client side and run fully within your browser. Visit the <a href="https://github.com/englacial/ismip-viewer">ismip-viewer repository</a> to contribute or report issues related to the viewer, or the <a href="https://github.com/earth-mover/icechunk">icechunk-js library</a> to contribute or report issues to the icechunk client.</p>
</section>
</section>
<section id="getting-started" class="level1">
<h1>Getting started</h1>
<p>Feel free to play around with the <a href="./static/models/">dedicated viewer</a> where you can add panels to compare models or experiments side-by-side, or just explore a single dataset at a time. The viewer panels are embeddable using <a href="https://mystmd.org">MyST</a> and <a href="https://quarto.org">Quarto</a> (or directly using an iframe); we’ve done that below with a few example comparisons we think are interesting.</p>
<section id="subglacial-temperature" class="level2">
<h2 class="anchored" data-anchor-id="subglacial-temperature">Subglacial temperature</h2>
<ul>
<li><strong>Variable:</strong> <code>litempbotgr</code> – Basal temperature beneath grounded ice sheet (K)</li>
<li><strong>Models:</strong> AWI/PISM1, DOE/MALI, LSCE/GRISLI2, NCAR/CISM</li>
<li><strong>Experiment:</strong> exp05</li>
</ul>
<p>There are few direct measurements of the temperature profile within or beneath ice sheets. As a result, basal temperature (temperature at the ice-bedrock interface) is poorly constrained. Models resolve a wide range of temperatures, ranging from deeply frozen to at or near the pressure melting point.</p>
<iframe src="./static/models/?autoload=true&amp;variable=litempbotgr&amp;panels=[     {&quot;model&quot;%3A&quot;AWI_PISM1&quot;%2C&quot;experiment&quot;%3A&quot;exp05&quot;}%2C     {&quot;model&quot;%3A&quot;DOE_MALI&quot;%2C&quot;experiment&quot;%3A&quot;exp05&quot;}%2C     {&quot;model&quot;%3A&quot;LSCE_GRISLI2&quot;%2C&quot;experiment&quot;%3A&quot;exp05&quot;}%2C     {&quot;model&quot;%3A&quot;NCAR_CISM&quot;%2C&quot;experiment&quot;%3A&quot;exp05&quot;}   ]&amp;controls=time&amp;store_url=https%3A%2F%2Fdata.source.coop%2Fenglacial%2Fismip6%2Ficechunk-ais%2F&amp;default_year=2025&amp;ignore_value=0" width="100%" height="750" style="border:1px solid #ccc;border-radius:5px" frameborder="0" loading="lazy"></iframe>
<p>For an accessible introduction to this topic, see Bethan Davies’ page on <a href="https://www.antarcticglaciers.org/glacier-processes/glacier-flow-2/glacial-processes/">glacier thermal regimes</a>.</p>
</section>
<section id="grounding-line-retreat-and-sub-ice-shelf-melt" class="level2">
<h2 class="anchored" data-anchor-id="grounding-line-retreat-and-sub-ice-shelf-melt">Grounding line retreat and sub-ice shelf melt</h2>
<ul>
<li><strong>Variable:</strong> <code>libmassbffl</code> – Basal mass balance flux beneath floating ice (kg m<sup>-2</sup> s<sup>-1</sup>)</li>
<li><strong>Model:</strong> DOE/MALI</li>
<li><strong>Experiments:</strong> exp05, exp07</li>
</ul>
<p><code>libmassbffl</code> shows the melt rates under floating ice shelves. It’s a good way to look at a major component of Antarctic mass loss and also visualize grounding line retreat. Experiments 5 and 7 represent the same assumptions but with different climate forcings. <code>exp05</code> is a high-emissions scenario (RCP 8.5) while <code>exp07</code> is a low-emission scenario (RCP 2.6).</p>
<p>This is a good comparison to zoom in on, play with the time slider to see how grounding lines evolve over time, and to use the color scale options as needed.</p>
<iframe src="./static/models/?autoload=true&amp;variable=libmassbffl&amp;panels=[     {&quot;model&quot;%3A&quot;DOE_MALI&quot;%2C&quot;experiment&quot;%3A&quot;exp05&quot;}%2C     {&quot;model&quot;%3A&quot;DOE_MALI&quot;%2C&quot;experiment&quot;%3A&quot;exp07&quot;}   ]&amp;controls=time&amp;store_url=https%3A%2F%2Fdata.source.coop%2Fenglacial%2Fismip6%2Ficechunk-ais%2F&amp;default_year=2025&amp;ignore_value=0&amp;layout=vertical" width="100%" height="750" style="border:1px solid #ccc;border-radius:5px" frameborder="0" loading="lazy"></iframe>
<p>For an accessible introduction to this topic, see Bethan Davies’ pages on <a href="https://www.antarcticglaciers.org/glacier-processes/grounding-lines/">grounding lines</a> and <a href="https://www.antarcticglaciers.org/glaciers-and-climate/changing-antarctica/shrinking-ice-shelves/">ice shelves</a>.</p>
</section>
<section id="surface-mass-balance" class="level2">
<h2 class="anchored" data-anchor-id="surface-mass-balance">Surface mass balance</h2>
<ul>
<li><strong>Variable:</strong> <code>acabf</code> – Surface mass balance flux (kg m<sup>-2</sup> s<sup>-1</sup>)</li>
<li><strong>Models:</strong> DOE/MALI, AWI/PISM1</li>
<li><strong>Experiments:</strong> exp05, exp07</li>
</ul>
<p>Surface mass balance refers to the net accumulation and ablation occurring at the surface of an ice sheet. In most of Antarctica, this primarily means “how much snow is falling?” Antarctica is huge, so small differences in snowfall over big areas can make an enormous difference. Patterns of surface mass balance change over time and vary with the selected climate forcing, so be sure to explore the time slider and look at differences between the low-emission (<code>exp07</code>) and high-emissions (<code>exp05</code>) experiments.</p>
<iframe src="./static/models/?autoload=true&amp;variable=acabf&amp;panels=[     {&quot;model&quot;%3A&quot;DOE_MALI&quot;%2C&quot;experiment&quot;%3A&quot;exp05&quot;}%2C     {&quot;model&quot;%3A&quot;DOE_MALI&quot;%2C&quot;experiment&quot;%3A&quot;exp07&quot;}%2C     {&quot;model&quot;%3A&quot;AWI_PISM1&quot;%2C&quot;experiment&quot;%3A&quot;exp05&quot;}%2C     {&quot;model&quot;%3A&quot;AWI_PISM1&quot;%2C&quot;experiment&quot;%3A&quot;exp07&quot;}   ]&amp;controls=time&amp;store_url=https%3A%2F%2Fdata.source.coop%2Fenglacial%2Fismip6%2Ficechunk-ais%2F&amp;default_year=2025" width="100%" height="750" style="border:1px solid #ccc;border-radius:5px" frameborder="0" loading="lazy"></iframe>
<p>For an accessible introduction to this topic, see Bethan Davies’ page on <a href="https://www.antarcticglaciers.org/glaciers-and-climate/changing-antarctica/antarctic-ice-sheet-surface-mass-balance/">Antarctic Ice Sheet mass balance</a>.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/englacial\.org");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>